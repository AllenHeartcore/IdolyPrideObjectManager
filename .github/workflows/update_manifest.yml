name: Update manifest

on:
    # Runs every three hours, on the hour
    schedule:
        - cron: "0 */3 * * *"
    # Allow manual triggering
    workflow_dispatch:

jobs:
    update-manifest:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2
              with:
                  ref: "refs/heads/manifest-update"
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: "3.x"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run update_manifest.py
              id: run_script
              run: |
                  python update_manifest.py
                  echo "exit_code=$?" >> $GITHUB_OUTPUT

            - name: Warn if up-to-date
              if: steps.run_script.outputs.exit_code == 1
              run: |
                  echo "Warning: Local manifest is up-to-date."
                  exit 0

            - name: Commit changes
              if: steps.run_script.outputs.exit_code == 0
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email ""
                  git add .
                  REV_NUMBER="$(cat manifests/LATEST_VERSION)"
                  git commit -m "Update manifest to revision v$REV_NUMBER"
                  git push origin manifest-update
